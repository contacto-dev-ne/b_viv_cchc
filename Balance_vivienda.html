<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance de Vivienda - Maule</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="bg-gray-50 text-slate-800">
    <div id="root"></div>

    <!-- React and Libraries (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Destructuring inside the App component or a helper to ensure Recharts is defined
        const getRecharts = () => window.Recharts || {};

        // CONFIGURACIÓN (GitHub Actions reemplazará estos valores)
        const CONFIG = {
            apiKey: 'AIzaSyDw1B16f6oMd3eA0JzFwMOVFA-NBbhnUqo',
            spreadsheetId: 'TgiF-DE_wjxw-CXBMUtAEVEmoZfgPlU5h8hcfE8Eg',
            range: 'A:Z'
        };

        const MAULE_STRUCTURE = {
            provincias: {
                'Talca': ['Talca', 'Constitución', 'Curepto', 'Empedrado', 'Maule', 'Pelarco', 'Pencahue', 'Río Claro', 'San Clemente', 'San Rafael'],
                'Curicó': ['Curicó', 'Hualañé', 'Licantén', 'Molina', 'Rauco', 'Romeral', 'Sagrada Familia', 'Teno', 'Vichuquén'],
                'Linares': ['Linares', 'Colbún', 'Longaví', 'Parral', 'Retiro', 'San Javier', 'Villa Alegre', 'Yerbas Buenas'],
                'Cauquenes': ['Cauquenes', 'Chanco', 'Pelluhue']
            }
        };

        const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1'];
        const ZONA_COLORS = ['#0ea5e9', '#22c55e'];
        const SEXO_COLORS = ['#6366f1', '#ec4899'];

        // --- COMPONENTES UI ---

        const Icon = ({ name, size = 18, color = "currentColor", className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size, color: color }} className={className}></i>;
        };

        const MetricCard = ({ title, value, icon, color = "blue" }) => (
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between overflow-hidden relative group hover:shadow-md transition-all">
                <div className={`absolute -right-4 -bottom-4 opacity-5 text-${color}-500 transform group-hover:scale-110 transition-transform`}>
                    <Icon name={icon} size={80} />
                </div>
                <div>
                    <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">{title}</p>
                    <h3 className="text-3xl font-bold text-slate-800">{value.toLocaleString('es-CL')}</h3>
                </div>
                <div className={`p-3 bg-${color}-50 rounded-xl text-${color}-600`}>
                    <Icon name={icon} size={24} />
                </div>
            </div>
        );

        const ChartBox = ({ title, icon, children, height = "h-80" }) => (
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div className="flex items-center gap-2 mb-6 border-b border-gray-50 pb-4">
                    <div className="p-2 bg-indigo-50 rounded-lg text-indigo-600">
                        <Icon name={icon} size={18} />
                    </div>
                    <h3 className="font-bold text-slate-800">{title}</h3>
                </div>
                <div className={height}>
                    {children}
                </div>
            </div>
        );

        // --- APP PRINCIPAL ---

        function App() {
            const {
                BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, Legend, ResponsiveContainer,
                PieChart, Pie, Cell
            } = getRecharts();

            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedYear, setSelectedYear] = useState(null);

            useEffect(() => {
                const loadData = async () => {
                    try {
                        // Si AIzaSyDw1B16f6oMd3eA0JzFwMOVFA-NBbhnUqo no ha sido reemplazado, intentamos usar una variable local si existe
                        if (CONFIG.apiKey.includes('{{')) {
                            console.warn("GitHub Secrets no inyectados aún. Trabajando en modo local/manual.");
                        }

                        const URL = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.spreadsheetId}/values/${CONFIG.range}?key=${CONFIG.apiKey}&valueRenderOption=UNFORMATTED_VALUE`;
                        const res = await fetch(URL);

                        if (!res.ok) throw new Error("Error de conexión con Google Sheets. Verifica el ID y la API Key.");

                        const result = await res.json();
                        const rows = result.values;
                        if (!rows || rows.length < 2) throw new Error("La hoja de cálculo está vacía.");

                        const headers = rows[0].map(h => h.trim());
                        const parsed = rows.slice(1).map(row => {
                            const obj = {};
                            headers.forEach((h, i) => {
                                let val = row[i];
                                if (['Año', 'Requerimientos'].includes(h)) val = Number(val);
                                obj[h] = val;
                            });
                            return obj;
                        });

                        setData(parsed);
                        const years = [...new Set(parsed.map(d => d.Año))].sort((a, b) => b - a);
                        setSelectedYear(years[0]);
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };
                loadData();
            }, []);

            const filteredData = useMemo(() => {
                return data.filter(d => d.Año === selectedYear);
            }, [data, selectedYear]);

            const aggregations = useMemo(() => {
                const res = { total: 0, gse: {}, deficit: {}, zona: {} };
                filteredData.forEach(d => {
                    res.total += (d.Requerimientos || 0);
                    res.gse[d.Grupo_socioeconomico] = (res.gse[d.Grupo_socioeconomico] || 0) + d.Requerimientos;
                    res.deficit[d.Componente_deficit] = (res.deficit[d.Componente_deficit] || 0) + d.Requerimientos;
                    res.zona[d.Zona] = (res.zona[d.Zona] || 0) + d.Requerimientos;
                });
                return {
                    total: res.total,
                    gse: Object.entries(res.gse).map(([name, value]) => ({ name, value })),
                    deficit: Object.entries(res.deficit).map(([name, value]) => ({ name, value })),
                    zona: Object.entries(res.zona).map(([name, value]) => ({ name, value }))
                };
            }, [filteredData]);

            if (loading) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50">
                    <div className="flex flex-col items-center gap-4">
                        <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                        <p className="font-bold text-slate-500">Cargando Visualizador...</p>
                    </div>
                </div>
            );

            if (error) return (
                <div className="min-h-screen flex items-center justify-center bg-red-50 p-6">
                    <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full text-center">
                        <div className="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6">
                            <Icon name="alert-circle" size={32} />
                        </div>
                        <h2 className="text-2xl font-bold text-slate-800 mb-2">Error de Conexión</h2>
                        <p className="text-slate-500 mb-6">{error}</p>
                        <div className="text-xs text-left bg-slate-50 p-4 rounded-xl text-slate-400 mb-6">
                            <strong>Pasos a seguir:</strong><br />
                            1. Verifica que la API Key en GitHub Secrets sea válida.<br />
                            2. Asegúrate de que la hoja de cálculo esté compartida como "Cualquier persona con el enlace".
                        </div>
                        <button onClick={() => window.location.reload()} className="w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition-colors">Reintentar</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen pb-20">
                    {/* Header */}
                    <header className="bg-white border-b border-gray-100 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-indigo-600 text-white rounded-2xl shadow-indigo-200 shadow-lg">
                                    <Icon name="home" size={24} />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-slate-800 leading-tight">Balance de Vivienda</h1>
                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Unidad de Estudios - Maule</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <span className="text-xs font-bold text-slate-400">AÑO</span>
                                <select
                                    className="bg-slate-100 border-none rounded-xl px-4 py-2 font-bold text-indigo-600 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                                    value={selectedYear}
                                    onChange={(e) => setSelectedYear(Number(e.target.value))}
                                >
                                    {[...new Set(data.map(d => d.Año))].sort((a, b) => b - a).map(y => (
                                        <option key={y} value={y}>{y}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-6 mt-10 space-y-8">
                        {/* Summary 卡片 */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <MetricCard title="Déficit Habitacional Total" value={aggregations.total} icon="users" color="indigo" />
                            <MetricCard title="Comunas Analizadas" value={30} icon="map-pin" color="blue" />
                            <MetricCard title="Datos Online" value="Google Sheets" icon="database" color="emerald" />
                            <MetricCard title="Evolución" value="+2.4%" icon="trending-up" color="amber" />
                        </div>

                        {/* Charts Area */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <ChartBox title="Componentes del Déficit" icon="alert-circle">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={aggregations.deficit}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                        <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{ fontSize: 10, fill: '#94a3b8' }} />
                                        <YAxis axisLine={false} tickLine={false} tick={{ fontSize: 10, fill: '#94a3b8' }} />
                                        <RechartsTooltip
                                            contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)' }}
                                            cursor={{ fill: '#f8fafc' }}
                                        />
                                        <Bar dataKey="value" fill="#4f46e5" radius={[4, 4, 0, 0]} barSize={40} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </ChartBox>

                            <ChartBox title="Distribución GSE" icon="pie-chart">
                                <ResponsiveContainer width="100%" height="100%">
                                    <PieChart>
                                        <Pie
                                            data={aggregations.gse}
                                            innerRadius={60}
                                            outerRadius={100}
                                            paddingAngle={5}
                                            dataKey="value"
                                        >
                                            {aggregations.gse.map((entry, index) => (
                                                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                            ))}
                                        </Pie>
                                        <RechartsTooltip contentStyle={{ borderRadius: '12px', border: 'none' }} />
                                        <Legend verticalAlign="bottom" height={36} />
                                    </PieChart>
                                </ResponsiveContainer>
                            </ChartBox>
                        </div>

                        <div className="grid grid-cols-1 gap-8">
                            <ChartBox title="Análisis por Zona" icon="map" height="h-64">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={aggregations.zona} layout="vertical">
                                        <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#f1f5f9" />
                                        <XAxis type="number" axisLine={false} tickLine={false} tick={{ fontSize: 10 }} />
                                        <YAxis dataKey="name" type="category" axisLine={false} tickLine={false} tick={{ fontSize: 11 }} width={80} />
                                        <RechartsTooltip contentStyle={{ borderRadius: '12px', border: 'none' }} />
                                        <Bar dataKey="value" radius={[0, 4, 4, 0]} barSize={30}>
                                            {aggregations.zona.map((entry, index) => (
                                                <Cell key={`cell-zona-${index}`} fill={ZONA_COLORS[index % ZONA_COLORS.length]} />
                                            ))}
                                        </Bar>
                                    </BarChart>
                                </ResponsiveContainer>
                            </ChartBox>
                        </div>
                    </main>

                    <footer className="max-w-7xl mx-auto px-6 mt-16 text-center text-slate-400 text-xs border-t border-gray-100 pt-8">
                        <p>© 2024 Cámara Chilena de la Construcción - Sede Maule</p>
                        <p className="mt-2">Visualizador Dinámico Conectado a Cloud Infrastructure</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>