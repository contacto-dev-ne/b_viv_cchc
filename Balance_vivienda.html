<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance de Vivienda - Maule</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <!-- Librerías Externas -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script crossorigin src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const {
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, Legend, ResponsiveContainer,
            PieChart, Pie, Cell
        } = window.Recharts;

        /**
         * CONFIGURACIÓN PARA GITHUB ACTIONS
         */
        const CONFIG = {
            apiKey: 'AIzaSyDw1B16f6oMd3eA0JzFwMOVFA-NBbhnUqo',
            spreadsheetId: '1QPTgiF-DE_wjxw-CXBMUtAEVEmoZfgPlU5h8hcfE8Eg',
            range: 'A:Z'
        };

        const MAULE_STRUCTURE = {
            provincias: {
                'Talca': [
                    { nombre: 'Talca', cut: '7101' }, { nombre: 'Constitución', cut: '7102' }, { nombre: 'Curepto', cut: '7103' },
                    { nombre: 'Empedrado', cut: '7104' }, { nombre: 'Maule', cut: '7105' }, { nombre: 'Pelarco', cut: '7106' },
                    { nombre: 'Pencahue', cut: '7107' }, { nombre: 'Río Claro', cut: '7108' }, { nombre: 'San Clemente', cut: '7109' },
                    { nombre: 'San Rafael', cut: '7110' },
                ],
                'Curicó': [
                    { nombre: 'Curicó', cut: '7301' }, { nombre: 'Hualañé', cut: '7302' }, { nombre: 'Licantén', cut: '7303' },
                    { nombre: 'Molina', cut: '7304' }, { nombre: 'Rauco', cut: '7305' }, { nombre: 'Romeral', cut: '7306' },
                    { nombre: 'Sagrada Familia', cut: '7307' }, { nombre: 'Teno', cut: '7308' }, { nombre: 'Vichuquén', cut: '7309' },
                ],
                'Linares': [
                    { nombre: 'Linares', cut: '7401' }, { nombre: 'Colbún', cut: '7402' }, { nombre: 'Longaví', cut: '7403' },
                    { nombre: 'Parral', cut: '7404' }, { nombre: 'Retiro', cut: '7405' }, { nombre: 'San Javier', cut: '7406' },
                    { nombre: 'Villa Alegre', cut: '7407' }, { nombre: 'Yerbas Buenas', cut: '7408' },
                ],
                'Cauquenes': [
                    { nombre: 'Cauquenes', cut: '7201' }, { nombre: 'Chanco', cut: '7202' }, { nombre: 'Pelluhue', cut: '7203' },
                ]
            }
        };

        const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1'];
        const ZONA_COLORS = ['#0ea5e9', '#22c55e'];
        const SEXO_COLORS = ['#6366f1', '#ec4899'];

        // --- COMPONENTE ICONO ---
        const Icon = ({ name, size = 18, color = "currentColor", className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size, color: color }} className={className}></i>;
        };

        // --- UTILIDAD: DESCARGA IMAGEN ---
        const downloadChartImage = (containerRef, title) => {
            if (!containerRef.current) return;
            // Intentar capturar el SVG del gráfico
            const svgElement = containerRef.current.querySelector('.recharts-responsive-container svg');
            if (!svgElement) {
                console.error("No se encontró el SVG del gráfico");
                return;
            }

            // Clonar el SVG para no modificar el original
            const clonedSvg = svgElement.cloneNode(true);
            const width = svgElement.clientWidth || 800;
            const height = svgElement.clientHeight || 400;

            // Asegurar dimensiones y estilos en el clon
            clonedSvg.setAttribute('width', width);
            clonedSvg.setAttribute('height', height);

            // Serializar
            const serializer = new XMLSerializer();
            let svgString = serializer.serializeToString(clonedSvg);

            // Corregir namespaces si faltan
            if (!svgString.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
                svgString = svgString.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            if (!svgString.match(/^<svg[^>]+xmlns:xlink="http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
                svgString = svgString.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
            }

            const svgBlob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
            const url = URL.createObjectURL(svgBlob);
            const img = new Image();

            img.onload = () => {
                const canvas = document.createElement('canvas');
                const scale = 2; // Para mejor calidad
                const titleHeight = 60;
                const padding = 20;

                canvas.width = (width + padding * 2) * scale;
                canvas.height = (height + titleHeight + padding * 2) * scale;

                const ctx = canvas.getContext('2d');
                ctx.scale(scale, scale);

                // Fondo blanco
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Título
                ctx.font = 'bold 20px Inter, sans-serif';
                ctx.fillStyle = '#1e293b';
                ctx.textAlign = 'center';
                ctx.fillText(title, (width + padding * 2) / 2, padding + 25);

                // Dibujar el gráfico
                ctx.drawImage(img, padding, titleHeight + padding, width, height);

                // Descargar
                const a = document.createElement('a');
                a.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.png`;
                a.href = canvas.toDataURL('image/png', 1.0);
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            img.src = url;
        };

        // --- COMPONENTES UI ---

        const Card = ({ title, value, icon: iconName, subtext, color = "blue" }) => (
            <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 flex items-start justify-between relative overflow-hidden">
                <div className={`absolute top-0 right-0 p-4 opacity-10 text-${color}-500`}>
                    <Icon name={iconName} size={64} />
                </div>
                <div>
                    <p className="text-sm font-medium text-gray-500 mb-1">{title}</p>
                    <h3 className="text-3xl font-bold text-gray-800">{value.toLocaleString('es-CL')}</h3>
                    {subtext && <p className={`text-xs mt-2 font-medium text-${color}-600`}>{subtext}</p>}
                </div>
                <div className={`p-3 bg-${color}-50 rounded-lg text-${color}-600 z-10`}>
                    <Icon name={iconName} size={24} />
                </div>
            </div>
        );

        const ChartCard = ({ title, icon: iconName, iconColor, children, containerHeight = "h-80", customStyle = {} }) => {
            const ref = useRef(null);
            return (
                <div ref={ref} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 relative group">
                    <div className="flex justify-between items-start mb-4">
                        <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <Icon name={iconName} size={18} className={iconColor} />
                            {title}
                        </h3>
                        <button
                            onClick={() => downloadChartImage(ref, title)}
                            className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all opacity-0 group-hover:opacity-100 focus:opacity-100"
                            title="Guardar gráfico como imagen"
                        >
                            <Icon name="camera" size={20} />
                        </button>
                    </div>
                    <div className={`w-full cursor-pointer ${containerHeight}`} style={customStyle}>
                        {children}
                    </div>
                </div>
            );
        };

        const KPICard = ({ title, value, prevValue, isTotal = false }) => {
            const hasPrev = prevValue !== undefined && prevValue !== null;
            const diff = hasPrev ? value - prevValue : 0;
            const percent = hasPrev && prevValue !== 0 ? (diff / prevValue) * 100 : 0;
            const isGood = diff < 0;
            const isNeutral = diff === 0;
            const TrendIcon = isNeutral ? 'minus' : (isGood ? 'trending-down' : 'trending-up');
            const trendColor = isNeutral ? 'text-gray-400' : (isGood ? 'text-green-500' : 'text-red-500');
            const trendBg = isNeutral ? 'bg-gray-100' : (isGood ? 'bg-green-50' : 'bg-red-50');

            return (
                <div className={`bg-white rounded-xl shadow-sm border ${isTotal ? 'border-blue-200 ring-1 ring-blue-100' : 'border-gray-100'} p-5 flex flex-col justify-between relative overflow-hidden transition-all hover:shadow-md`}>
                    <div>
                        <p className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 h-8 line-clamp-2">{title}</p>
                        <div className="flex items-baseline gap-2">
                            <h3 className={`font-bold text-gray-800 ${isTotal ? 'text-3xl' : 'text-2xl'}`}>{value.toLocaleString('es-CL')}</h3>
                            {isTotal && <span className="text-xs text-gray-400 font-medium">hogares</span>}
                        </div>
                    </div>
                    {hasPrev ? (
                        <div className="mt-4 flex items-center gap-2">
                            <div className={`flex items-center px-2 py-1 rounded-full text-xs font-bold ${trendColor} ${trendBg}`}>
                                <Icon name={TrendIcon} size={14} className="mr-1" />
                                {Math.abs(percent).toFixed(1)}%
                            </div>
                            <span className="text-xs text-gray-400">
                                {diff > 0 ? '+' : ''}{diff.toLocaleString('es-CL')} vs año anterior
                            </span>
                        </div>
                    ) : (
                        <div className="mt-4 text-xs text-gray-300 italic">Sin datos previos</div>
                    )}
                </div>
            );
        };

        const FilterDropdown = ({ label, options, selected, onChange, placeholder = "Seleccionar...", singleSelect = false }) => {
            const [isOpen, setIsOpen] = useState(false);
            const toggleOption = (option) => {
                if (singleSelect) { onChange(option); setIsOpen(false); return; }
                const isSelected = selected.includes(option);
                const newSelected = isSelected ? selected.filter(item => item !== option) : [...selected, option];
                onChange(newSelected);
            };
            const getLabel = () => {
                if (singleSelect) return selected || placeholder;
                return selected.length === 0 ? <span className="text-gray-400">{placeholder}</span> :
                    selected.length === options.length ? `Todos (${options.length})` : `${selected.length} seleccionados`;
            };
            return (
                <div className="relative w-full">
                    <label className="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wider">{label}</label>
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-full bg-white border border-gray-300 hover:border-blue-500 text-left px-3 py-2 rounded-lg text-sm flex justify-between items-center transition-colors shadow-sm"
                    >
                        <span className="truncate block pr-4">{getLabel()}</span>
                        <Icon name={isOpen ? 'chevron-up' : 'chevron-down'} size={16} />
                    </button>
                    {isOpen && (
                        <div className="absolute z-50 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-xl max-h-60 overflow-y-auto">
                            {!singleSelect && (
                                <div
                                    className="px-3 py-2 border-b border-gray-100 text-xs font-bold text-blue-600 cursor-pointer hover:bg-blue-50"
                                    onClick={() => onChange(selected.length === options.length ? [] : options)}
                                >
                                    {selected.length === options.length ? "Desmarcar todos" : "Seleccionar todos"}
                                </div>
                            )}
                            {options.map((opt) => {
                                const isSelected = singleSelect ? selected === opt : selected.includes(opt);
                                return (
                                    <div key={opt} className="px-3 py-2 hover:bg-gray-50 cursor-pointer flex items-center text-sm" onClick={() => toggleOption(opt)}>
                                        {!singleSelect && (
                                            <div className={`w-4 h-4 rounded border flex items-center justify-center mr-2 ${isSelected ? 'bg-blue-500 border-blue-500' : 'border-gray-300'}`}>
                                                {isSelected && <Icon name="check" size={12} color="white" />}
                                            </div>
                                        )}
                                        {singleSelect && isSelected && <Icon name="check" size={16} className="text-blue-500 mr-2" />}
                                        <span className={isSelected ? 'text-gray-900 font-medium' : 'text-gray-600'}>{opt}</span>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // --- APP PRINCIPAL ---

        function App() {
            const [rawData, setRawData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isFiltersOpen, setIsFiltersOpen] = useState(true);
            const [isKPIsOpen, setIsKPIsOpen] = useState(true);
            const [isYearDropdownOpen, setIsYearDropdownOpen] = useState(false);

            // Filtros
            const [selectedYear, setSelectedYear] = useState(null);
            const [selectedProvincias, setSelectedProvincias] = useState([]);
            const [selectedComunas, setSelectedComunas] = useState([]);
            const [selectedGSE, setSelectedGSE] = useState([]);
            const [selectedDeficit, setSelectedDeficit] = useState([]);
            const [interactiveFilters, setInteractiveFilters] = useState({
                sexo: null, zona: null, gse: null, deficit: null, comuna: null, tipoHogar: null, educacion: null
            });

            const [options, setOptions] = useState({ years: [], provincias: [], comunas: [], gse: [], deficit: [] });

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const URL = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.spreadsheetId}/values/${CONFIG.range}?key=${CONFIG.apiKey}&valueRenderOption=UNFORMATTED_VALUE`;
                        const res = await fetch(URL);
                        if (!res.ok) throw new Error('Error al conectar con Google Sheets.');
                        const result = await res.json();
                        const rows = result.values;
                        if (!rows) throw new Error('Sin datos');
                        const headers = rows[0].map(h => h.trim());
                        const parsed = rows.slice(1).map(row => {
                            const obj = {};
                            headers.forEach((h, i) => {
                                let val = row[i];
                                if (['Requerimientos', 'Año'].includes(h)) val = Number(val);
                                obj[h] = val;
                            });
                            if (!obj.Provincia) {
                                for (const [prov, comps] of Object.entries(MAULE_STRUCTURE.provincias)) {
                                    if (comps.find(c => c.nombre === obj.Comuna)) { obj.Provincia = prov; break; }
                                }
                            }
                            return obj;
                        });
                        setRawData(parsed);
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, []);

            useEffect(() => {
                if (rawData.length > 0) {
                    const years = [...new Set(rawData.map(d => d.Año))].sort((a, b) => a - b);
                    const provs = Object.keys(MAULE_STRUCTURE.provincias);
                    const coms = [...new Set(rawData.map(d => d.Comuna))].sort();
                    const gse = [...new Set(rawData.map(d => d.Grupo_socioeconomico))].filter(Boolean);
                    const def = [...new Set(rawData.map(d => d.Componente_deficit))].filter(Boolean);
                    setOptions({ years, provincias: provs, comunas: coms, gse, deficit: def });
                    if (!selectedYear) setSelectedYear(years.includes(2025) ? 2025 : years[years.length - 1]);
                    if (selectedProvincias.length === 0) setSelectedProvincias(provs);
                    if (selectedComunas.length === 0) setSelectedComunas(coms);
                }
            }, [rawData]);

            const toggleInteractive = (cat, val) => setInteractiveFilters(p => ({ ...p, [cat]: p[cat] === val ? null : val }));
            const clearInteractive = () => setInteractiveFilters({ sexo: null, zona: null, gse: null, deficit: null, comuna: null, tipoHogar: null, educacion: null });

            const filteredAll = useMemo(() => {
                return rawData.filter(d => {
                    if (selectedProvincias.length > 0 && !selectedProvincias.includes(d.Provincia)) return false;
                    if (selectedComunas.length > 0 && !selectedComunas.includes(d.Comuna)) return false;
                    if (interactiveFilters.sexo && d.Sexo !== interactiveFilters.sexo) return false;
                    if (interactiveFilters.zona && d.Zona !== interactiveFilters.zona) return false;
                    if (interactiveFilters.gse && d.Grupo_socioeconomico !== interactiveFilters.gse) return false;
                    if (interactiveFilters.deficit && d.Componente_deficit !== interactiveFilters.deficit) return false;
                    if (interactiveFilters.comuna && d.Comuna !== interactiveFilters.comuna) return false;
                    if (interactiveFilters.tipoHogar && d.Tipo_hogar !== interactiveFilters.tipoHogar) return false;
                    if (interactiveFilters.educacion && d.Educacion !== interactiveFilters.educacion) return false;
                    if (selectedGSE.length > 0 && !selectedGSE.includes(d.Grupo_socioeconomico)) return false;
                    if (selectedDeficit.length > 0 && !selectedDeficit.includes(d.Componente_deficit)) return false;
                    return true;
                });
            }, [rawData, selectedProvincias, selectedComunas, interactiveFilters, selectedGSE, selectedDeficit]);

            const filteredData = useMemo(() => selectedYear ? filteredAll.filter(d => d.Año === selectedYear) : filteredAll, [filteredAll, selectedYear]);

            const kpi = useMemo(() => {
                if (!selectedYear || options.years.length === 0) return null;
                const years = [...options.years].sort((a, b) => a - b);
                const curIdx = years.indexOf(selectedYear);
                const prevYear = curIdx > 0 ? years[curIdx - 1] : null;
                const curData = filteredAll.filter(d => d.Año === selectedYear);
                const prevData = prevYear ? filteredAll.filter(d => d.Año === prevYear) : [];
                const sum = (d) => d.reduce((a, c) => a + (c.Requerimientos || 0), 0);
                return {
                    total: { value: sum(curData), prev: sum(prevData) },
                    components: options.deficit.map(c => ({ name: c, value: sum(curData.filter(x => x.Componente_deficit === c)), prev: sum(prevData.filter(x => x.Componente_deficit === c)) })),
                    prevYear, hasPrev: !!prevYear
                };
            }, [filteredAll, selectedYear, options]);

            const totalReq = filteredData.reduce((a, c) => a + (c.Requerimientos || 0), 0);
            const fmt = (v, n) => [`${new Intl.NumberFormat('es-CL').format(v)} (${((v / totalReq) * 100).toFixed(1).replace('.', ',')}%)`, n];
            const aggregate = (key) => {
                const m = {};
                filteredData.forEach(d => { m[d[key] || 'N/A'] = (m[d[key] || 'N/A'] || 0) + (d.Requerimientos || 0); });
                return Object.entries(m).map(([name, value]) => ({ name, value }));
            };

            const dataByComuna = aggregate('Comuna').sort((a, b) => b.value - a.value);
            const dataByGSE = aggregate('Grupo_socioeconomico');
            const dataByZona = aggregate('Zona');
            const dataBySexo = aggregate('Sexo');
            const dataByTipo = aggregate('Tipo_hogar').sort((a, b) => b.value - a.value);
            const dataByEduc = aggregate('Educacion').sort((a, b) => b.value - a.value);
            const dataByDef = aggregate('Componente_deficit');

            const comparison = useMemo(() => {
                const m = {};
                filteredAll.forEach(d => {
                    if (!m[d.Comuna]) m[d.Comuna] = { name: d.Comuna, provincia: d.Provincia };
                    m[d.Comuna][d.Año] = (m[d.Comuna][d.Año] || 0) + d.Requerimientos;
                });
                return Object.values(m).sort((a, b) => a.name.localeCompare(b.name));
            }, [filteredAll]);

            if (loading) return (
                <div className="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                    <p className="text-gray-600 font-medium">Cargando datos del Maule...</p>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans">
                    <header className="bg-white border-b border-gray-200 sticky top-0 z-30 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <img src="https://lh3.googleusercontent.com/d/1ox7eOnjJquQM2QbjZd92YO4l5OZrQmtg" alt="Logo CChC" className="h-14 w-auto object-contain mr-2" />
                                <div>
                                    <h1 className="text-xl font-bold text-gray-900 leading-tight">Balance de Vivienda</h1>
                                    <p className="text-xs text-gray-500 font-medium tracking-wide">REGIÓN DEL MAULE</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="relative">
                                    <button onClick={() => setIsYearDropdownOpen(!isYearDropdownOpen)} className="flex items-center bg-gray-50 border border-gray-200 hover:border-blue-400 px-3 py-1.5 rounded-lg transition-colors">
                                        <span className="text-xs font-bold text-gray-500 mr-2">AÑO</span>
                                        <span className="text-sm font-bold text-blue-700">{selectedYear || '-'}</span>
                                        <Icon name="chevron-down" size={14} className="ml-2 text-gray-400" />
                                    </button>
                                    {isYearDropdownOpen && (
                                        <div className="absolute right-0 mt-1 w-32 bg-white border border-gray-200 rounded-lg shadow-xl z-50">
                                            {options.years.map(y => (
                                                <div key={y} className={`px-4 py-2 text-sm cursor-pointer hover:bg-gray-50 ${selectedYear === y ? 'font-bold text-blue-600 bg-blue-50' : 'text-gray-700'}`} onClick={() => { setSelectedYear(y); setIsYearDropdownOpen(false); }}>{y}</div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <Icon name="wifi" size={22} className="text-green-500" />
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 mb-8 overflow-visible relative z-40">
                            <div className="p-4 flex justify-between items-center cursor-pointer hover:bg-gray-50" onClick={() => setIsFiltersOpen(!isFiltersOpen)}>
                                <div className="flex items-center gap-2 text-gray-700"><Icon name="filter" size={18} /><h2 className="font-semibold">Segmentación de Datos</h2></div>
                                <Icon name={isFiltersOpen ? 'minimize-2' : 'maximize-2'} size={16} className="text-gray-400" />
                            </div>
                            {isFiltersOpen && (
                                <div className="p-4 pt-0 border-t border-gray-100 mt-2">
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 pt-4 overflow-visible">
                                        <FilterDropdown label="Provincias" options={options.provincias} selected={selectedProvincias} onChange={p => { setSelectedProvincias(p); const next = []; p.forEach(x => next.push(...MAULE_STRUCTURE.provincias[x].map(c => c.nombre))); setSelectedComunas(next); }} />
                                        <FilterDropdown label="Comunas" options={options.comunas} selected={selectedComunas} onChange={setSelectedComunas} />
                                        <FilterDropdown label="G. Socioeconómico" options={options.gse} selected={selectedGSE} onChange={setSelectedGSE} />
                                        <FilterDropdown label="Déficit" options={options.deficit} selected={selectedDeficit} onChange={setSelectedDeficit} />
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="space-y-6 animate-in">
                            <div className="flex flex-wrap items-center gap-2 mb-2">
                                <span className="bg-blue-100 text-blue-800 text-xs font-bold px-2.5 py-0.5 rounded border border-blue-200">DATOS AÑO {selectedYear}</span>
                                {Object.values(interactiveFilters).some(x => x) && (
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs text-gray-500 font-medium">Filtros activos:</span>
                                        {Object.entries(interactiveFilters).map(([k, v]) => v && <span key={k} className="bg-indigo-100 text-indigo-700 text-xs px-2 py-0.5 rounded border border-indigo-200 flex items-center gap-1">{v}<button onClick={() => toggleInteractive(k, v)}><Icon name="x" size={12} /></button></span>)}
                                        <button onClick={clearInteractive} className="text-xs text-red-500 underline ml-2">Limpiar todo</button>
                                    </div>
                                )}
                            </div>
                            <Card title="Déficit Habitacional Total" value={totalReq} icon="home" subtext={`${selectedComunas.length} Comunas`} />
                            {kpi && (
                                <div className="bg-white rounded-xl shadow-sm border border-gray-200 mb-6 overflow-hidden">
                                    <div className="px-6 py-4 flex justify-between items-center cursor-pointer hover:bg-gray-50 border-b" onClick={() => setIsKPIsOpen(!isKPIsOpen)}>
                                        <h2 className="font-bold text-lg">Variación respecto a {kpi.hasPrev ? kpi.prevYear : 'año anterior'}</h2>
                                        <Icon name={isKPIsOpen ? 'minimize-2' : 'maximize-2'} size={18} />
                                    </div>
                                    {isKPIsOpen && (
                                        <div className="p-6 bg-slate-50/50">
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                                <KPICard title="Déficit Habitacional Total" value={kpi.total.value} prevValue={kpi.hasPrev ? kpi.total.prev : null} isTotal />
                                                {kpi.components.map(c => <KPICard key={c.name} title={c.name} value={c.value} prevValue={kpi.hasPrev ? c.prev : null} />)}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <ChartCard title="Componentes del Déficit" icon="alert-circle" iconColor="text-amber-500">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={dataByDef}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                            <XAxis dataKey="name" tick={{ fontSize: 11 }} interval={0} />
                                            <YAxis /><RechartsTooltip formatter={fmt} />
                                            <Bar dataKey="value" fill="#f59e0b" radius={[4, 4, 0, 0]} barSize={60} onClick={e => toggleInteractive('deficit', e.name)} cursor="pointer" />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </ChartCard>
                                <ChartCard title="Por Grupo Socioeconómico" icon="users" iconColor="text-emerald-500">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie data={dataByGSE} cx="50%" cy="50%" innerRadius={60} outerRadius={100} paddingAngle={5} dataKey="value" onClick={e => toggleInteractive('gse', e.name)} cursor="pointer">
                                                {dataByGSE.map((e, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                                            </Pie>
                                            <RechartsTooltip formatter={fmt} /><Legend verticalAlign="bottom" height={36} />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </ChartCard>
                            </div>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <ChartCard title="Sexo del Jefe de Hogar" icon="user" iconColor="text-indigo-500">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={dataBySexo}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                            <XAxis dataKey="name" tick={{ fontSize: 11 }} /><YAxis /><RechartsTooltip formatter={fmt} />
                                            <Bar dataKey="value" radius={[4, 4, 0, 0]} barSize={60} onClick={e => toggleInteractive('sexo', e.name)} cursor="pointer">
                                                {dataBySexo.map((e, i) => <Cell key={i} fill={SEXO_COLORS[i % SEXO_COLORS.length]} />)}
                                            </Bar>
                                        </BarChart>
                                    </ResponsiveContainer>
                                </ChartCard>
                                <ChartCard title="Por Zona (Urbano / Rural)" icon="tree-pine" iconColor="text-sky-500">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie data={dataByZona} cx="50%" cy="50%" outerRadius={100} dataKey="value" onClick={e => toggleInteractive('zona', e.name)} cursor="pointer">
                                                {dataByZona.map((e, i) => <Cell key={i} fill={ZONA_COLORS[i % ZONA_COLORS.length]} />)}
                                            </Pie>
                                            <RechartsTooltip formatter={fmt} /><Legend verticalAlign="bottom" height={36} />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </ChartCard>
                            </div>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <ChartCard title="Tipo de Hogar" icon="layout-list" iconColor="text-purple-500">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={dataByTipo} layout="vertical">
                                            <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                            <XAxis type="number" /><YAxis type="category" dataKey="name" width={140} tick={{ fontSize: 10 }} interval={0} />
                                            <RechartsTooltip formatter={fmt} /><Bar dataKey="value" fill="#8b5cf6" radius={[0, 4, 4, 0]} onClick={e => toggleInteractive('tipoHogar', e.name)} cursor="pointer" />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </ChartCard>
                                <ChartCard title="Nivel Educacional" icon="graduation-cap" iconColor="text-teal-500">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie data={dataByEduc} cx="50%" cy="50%" innerRadius={60} outerRadius={100} paddingAngle={2} dataKey="value" onClick={e => toggleInteractive('educacion', e.name)} cursor="pointer">
                                                {dataByEduc.map((e, i) => <Cell key={i} fill={COLORS[(i + 3) % COLORS.length]} />)}
                                            </Pie>
                                            <RechartsTooltip formatter={fmt} /><Legend verticalAlign="bottom" height={36} />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </ChartCard>
                            </div>
                            <ChartCard title="Distribución Geográfica" icon="map" iconColor="text-blue-500" containerHeight="" customStyle={{ height: Math.max(350, dataByComuna.length * 40) + 'px' }}>
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={dataByComuna} layout="vertical" margin={{ left: 40, right: 30 }}>
                                        <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                        <XAxis type="number" /><YAxis type="category" dataKey="name" width={120} tick={{ fontSize: 11 }} />
                                        <RechartsTooltip formatter={fmt} /><Bar dataKey="value" fill="#3b82f6" radius={[0, 4, 4, 0]} onClick={e => toggleInteractive('comuna', e.name)} cursor="pointer" />
                                    </BarChart>
                                </ResponsiveContainer>
                            </ChartCard>

                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-visible">
                                <div className="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
                                    <h3 className="font-bold text-gray-700">Matriz Comparativa Anual por Comuna</h3>
                                    <button
                                        onClick={() => {
                                            const headers = ["Provincia", "Comuna", ...options.years, "Variacion"];
                                            const csvRows = [headers.join(",")];
                                            comparison.forEach(r => {
                                                const v = options.years.map(y => r[y] || 0);
                                                const d = (v[v.length - 1] || 0) - (v[v.length - 2] || 0);
                                                const row = [r.provincia, r.name, ...v, d];
                                                csvRows.push(row.join(","));
                                            });
                                            const blob = new Blob([csvRows.join("\n")], { type: 'text/csv;charset=utf-8;' });
                                            const link = document.createElement("a");
                                            link.href = URL.createObjectURL(blob);
                                            link.setAttribute("download", "balance_vivienda_maule.csv");
                                            document.body.appendChild(link);
                                            link.click();
                                            document.body.removeChild(link);
                                        }}
                                        className="text-blue-600 font-medium flex items-center gap-1 hover:text-blue-800 transition-colors"
                                    >
                                        <Icon name="download" size={16} /> Exportar CSV
                                    </button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left text-gray-500">
                                        <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                            <tr>
                                                <th className="px-6 py-3">Provincia</th>
                                                <th className="px-6 py-3">Comuna</th>
                                                {options.years.map(y => <th key={y} className="px-6 py-3 text-right">{y}</th>)}
                                                <th className="px-6 py-3 text-right">Variación ({options.years[options.years.length - 1]} vs {options.years[options.years.length - 2] || '-'})</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {comparison.map((r, i) => {
                                                const v = options.years.map(y => r[y] || 0);
                                                const last = v[v.length - 1] || 0;
                                                const prev = v[v.length - 2] || 0;
                                                const d = last - prev;
                                                return (
                                                    <tr key={i} className="bg-white border-b hover:bg-gray-50">
                                                        <td className="px-6 py-4 font-medium text-gray-900">{r.provincia}</td>
                                                        <td className="px-6 py-4">{r.name}</td>
                                                        {options.years.map(y => <td key={y} className="px-6 py-4 text-right font-mono">{r[y] ? r[y].toLocaleString('es-CL') : '-'}</td>)}
                                                        <td className={`px-6 py-4 text-right font-bold ${d > 0 ? 'text-red-500' : 'text-green-500'}`}>
                                                            {v.length > 1 && (d > 0 ? '+' : '')}{d.toLocaleString('es-CL')}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </main>

                    <footer className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center text-gray-400 text-sm">
                        Plataforma de visualización de datos de vivienda región del Maule.
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>