<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance de Vivienda - Maule</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>

<body class="bg-[#f8fafc] text-slate-800">
    <div id="root"></div>

    <!-- Librerías Externas -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script crossorigin src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const {
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, Legend, ResponsiveContainer,
            PieChart, Pie, Cell
        } = window.Recharts;

        // --- CONFIGURACIÓN ---
        const CONFIG = {
            apiKey: '{{VITE_GOOGLE_API_KEY}}',
            spreadsheetId: '{{VITE_HOUSING_SHEET_ID}}',
            range: 'A:Z'
        };

        const MAULE_STRUCTURE = {
            provincias: {
                'Talca': ['Talca', 'Constitución', 'Curepto', 'Empedrado', 'Maule', 'Pelarco', 'Pencahue', 'Río Claro', 'San Clemente', 'San Rafael'],
                'Curicó': ['Curicó', 'Hualañé', 'Licantén', 'Molina', 'Rauco', 'Romeral', 'Sagrada Familia', 'Teno', 'Vichuquén'],
                'Linares': ['Linares', 'Colbún', 'Longaví', 'Parral', 'Retiro', 'San Javier', 'Villa Alegre', 'Yerbas Buenas'],
                'Cauquenes': ['Cauquenes', 'Chanco', 'Pelluhue']
            }
        };

        const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1'];
        const ZONA_COLORS = ['#0ea5e9', '#22c55e'];
        const SEXO_COLORS = ['#6366f1', '#ec4899'];

        // --- COMPONENTES UI ---

        const Icon = ({ name, size = 18, color = "currentColor", className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });
            const lucideName = name.toLowerCase().replace(/([a-z])([A-Z])/g, '$1-$2');
            return <i data-lucide={lucideName} style={{ width: size, height: size, color: color }} className={className}></i>;
        };

        const Card = ({ title, value, icon: iconName, subtext, color = "blue" }) => (
            <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex items-start justify-between relative overflow-hidden group hover:shadow-md transition-all">
                <div className={`absolute top-0 right-0 p-4 opacity-10 text-${color}-500 transform group-hover:scale-110 transition-transform`}>
                    <Icon name={iconName} size={64} />
                </div>
                <div>
                    <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">{title}</p>
                    <h3 className="text-3xl font-black text-slate-800 tracking-tight">{value.toLocaleString('es-CL')}</h3>
                    {subtext && <p className="text-[10px] mt-2 font-bold text-slate-400 uppercase">{subtext}</p>}
                </div>
                <div className={`p-3 bg-${color}-50 rounded-xl text-${color}-600 z-10`}>
                    <Icon name={iconName} size={24} />
                </div>
            </div>
        );

        const KPICard = ({ title, value, prevValue, isTotal = false }) => {
            const hasPrev = prevValue !== undefined && prevValue !== null;
            const diff = hasPrev ? value - prevValue : 0;
            const percent = hasPrev && prevValue !== 0 ? (diff / prevValue) * 100 : 0;
            const isGood = diff < 0;

            return (
                <div className={`bg-white rounded-2xl shadow-sm border ${isTotal ? 'border-indigo-200 ring-2 ring-indigo-50' : 'border-slate-100'} p-5 flex flex-col justify-between transition-all hover:shadow-md h-full`}>
                    <div>
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 h-8 line-clamp-2">{title}</p>
                        <div className="flex items-baseline gap-2">
                            <h3 className={`font-black text-slate-800 ${isTotal ? 'text-3xl' : 'text-2xl'}`}>{value.toLocaleString('es-CL')}</h3>
                            {isTotal && <span className="text-[10px] text-slate-400 font-bold uppercase">Hogares</span>}
                        </div>
                    </div>
                    {hasPrev && (
                        <div className="mt-4 flex items-center gap-2">
                            <div className={`flex items-center px-2 py-0.5 rounded-full text-[10px] font-black ${isGood ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}`}>
                                {percent > 0 ? '+' : ''}{percent.toFixed(1)}%
                            </div>
                            <span className="text-[10px] text-slate-400 font-bold uppercase">vs año anterior</span>
                        </div>
                    )}
                </div>
            );
        };

        const ChartCard = ({ title, icon: iconName, iconColor, children, height = "h-80" }) => (
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 relative group">
                <div className="flex items-center gap-3 mb-6">
                    <div className={`p-2 rounded-xl bg-slate-50 ${iconColor}`}>
                        <Icon name={iconName} size={20} />
                    </div>
                    <h3 className="font-bold text-slate-800 tracking-tight">{title}</h3>
                </div>
                <div className={`${height} w-full`}>
                    {children}
                </div>
            </div>
        );

        const FilterDropdown = ({ label, options, selected, onChange, placeholder = "Seleccionar...", single = false }) => {
            const [isOpen, setIsOpen] = useState(false);
            const ref = useRef(null);

            useEffect(() => {
                const handleClickOutside = (e) => { if (ref.current && !ref.current.contains(e.target)) setIsOpen(false); };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const toggle = (opt) => {
                if (single) { onChange(opt); setIsOpen(false); return; }
                const next = selected.includes(opt) ? selected.filter(i => i !== opt) : [...selected, opt];
                onChange(next);
            };

            const getLabel = () => {
                if (single) return selected || placeholder;
                return selected.length === 0 ? <span className="text-slate-400">{placeholder}</span> :
                    selected.length === options.length ? `Todos (${options.length})` : `${selected.length} seleccionados`;
            };

            return (
                <div className="relative w-full" ref={ref}>
                    <label className="block text-[10px] font-black text-slate-500 uppercase tracking-[0.1em] mb-1.5 ml-1">{label}</label>
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full bg-white border border-slate-200 hover:border-indigo-400 text-left px-4 py-2.5 rounded-xl text-xs font-bold flex justify-between items-center shadow-sm transition-all focus:ring-2 focus:ring-indigo-100 outline-none">
                        <span className="truncate">{getLabel()}</span>
                        <Icon name={isOpen ? 'ChevronUp' : 'ChevronDown'} size={14} className="text-slate-400" />
                    </button>
                    {isOpen && (
                        <div className="absolute z-[100] mt-2 w-full bg-white border border-slate-100 rounded-2xl shadow-xl py-2 max-h-60 overflow-y-auto custom-scrollbar animate-in">
                            {!single && (
                                <div onClick={() => onChange(selected.length === options.length ? [] : options)} className="px-4 py-2 text-[10px] font-black text-indigo-600 border-b border-slate-50 cursor-pointer hover:bg-slate-50 uppercase tracking-widest">
                                    {selected.length === options.length ? "Desmarcar todos" : "Seleccionar todos"}
                                </div>
                            )}
                            {options.map(opt => (
                                <div key={opt} onClick={() => toggle(opt)} className="px-4 py-2.5 hover:bg-slate-50 cursor-pointer flex items-center gap-3 text-xs font-semibold text-slate-600">
                                    {!single && <div className={`w-4 h-4 rounded border flex items-center justify-center transition-all ${selected.includes(opt) ? 'bg-indigo-600 border-indigo-600' : 'border-slate-300'}`}>
                                        {selected.includes(opt) && <Icon name="Check" size={10} color="white" />}
                                    </div>}
                                    {single && selected === opt && <Icon name="Check" size={14} className="text-indigo-600" />}
                                    <span className={((single && selected === opt) || (!single && selected.includes(opt))) ? 'text-indigo-600 font-bold' : ''}>{opt}</span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- APP PRINCIPAL ---

        function App() {
            const [rawData, setRawData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            // Estado UI
            const [activeTab, setActiveTab] = useState('analisis');
            const [isFiltersOpen, setIsFiltersOpen] = useState(true);
            const [isKPIsOpen, setIsKPIsOpen] = useState(true);
            const [isYearOpen, setIsYearOpen] = useState(false);

            // Filtros
            const [selectedYear, setSelectedYear] = useState(null);
            const [selectedProvincias, setSelectedProvincias] = useState([]);
            const [selectedComunas, setSelectedComunas] = useState([]);
            const [selectedGSE, setSelectedGSE] = useState([]);
            const [selectedDeficit, setSelectedDeficit] = useState([]);

            const [interactive, setInteractive] = useState({
                sexo: null, zona: null, gse: null, deficit: null, comuna: null, tipoHogar: null, educacion: null
            });

            useEffect(() => {
                const load = async () => {
                    try {
                        const URL = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.spreadsheetId}/values/${CONFIG.range}?key=${CONFIG.apiKey}&valueRenderOption=UNFORMATTED_VALUE`;
                        const res = await fetch(URL);
                        if (!res.ok) throw new Error(`Error de conexión (Status ${res.status}). Verifica tus claves API.`);

                        const result = await res.json();
                        const rows = result.values;
                        if (!rows || rows.length < 2) throw new Error("La hoja está vacía o no tiene el formato correcto.");

                        const headers = rows[0].map(h => h.trim());
                        const parsed = rows.slice(1).map(row => {
                            const obj = {};
                            headers.forEach((h, i) => {
                                let val = row[i];
                                if (['Año', 'Requerimientos'].includes(h)) val = Number(val);
                                obj[h] = val;
                            });
                            // Provincia mapping si no viene
                            if (!obj.Provincia) {
                                for (const [p, coms] of Object.entries(MAULE_STRUCTURE.provincias)) {
                                    if (coms.includes(obj.Comuna)) { obj.Provincia = p; break; }
                                }
                            }
                            return obj;
                        });

                        setRawData(parsed);
                        const years = [...new Set(parsed.map(d => d.Año))].sort((a, b) => b - a);
                        setSelectedYear(years[0]);
                        setSelectedProvincias(Object.keys(MAULE_STRUCTURE.provincias));
                        setSelectedComunas([...new Set(parsed.map(d => d.Comuna))].sort());
                        setSelectedGSE([...new Set(parsed.map(d => d.Grupo_socioeconomico))].filter(Boolean));
                        setSelectedDeficit([...new Set(parsed.map(d => d.Componente_deficit))].filter(Boolean));
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };
                load();
            }, []);

            const options = useMemo(() => ({
                years: [...new Set(rawData.map(d => d.Año))].sort((a, b) => b - a),
                provincias: Object.keys(MAULE_STRUCTURE.provincias),
                comunas: [...new Set(rawData.map(d => d.Comuna))].sort(),
                gse: [...new Set(rawData.map(d => d.Grupo_socioeconomico))].filter(Boolean),
                deficit: [...new Set(rawData.map(d => d.Componente_deficit))].filter(Boolean)
            }), [rawData]);

            const filteredAll = useMemo(() => {
                return rawData.filter(d => {
                    if (selectedProvincias.length > 0 && !selectedProvincias.includes(d.Provincia)) return false;
                    if (selectedComunas.length > 0 && !selectedComunas.includes(d.Comuna)) return false;
                    if (selectedGSE.length > 0 && !selectedGSE.includes(d.Grupo_socioeconomico)) return false;
                    if (selectedDeficit.length > 0 && !selectedDeficit.includes(d.Componente_deficit)) return false;

                    if (interactive.sexo && d.Sexo !== interactive.sexo) return false;
                    if (interactive.zona && d.Zona !== interactive.zona) return false;
                    if (interactive.gse && d.Grupo_socioeconomico !== interactive.gse) return false;
                    if (interactive.deficit && d.Componente_deficit !== interactive.deficit) return false;
                    if (interactive.comuna && d.Comuna !== interactive.comuna) return false;
                    if (interactive.tipoHogar && d.Tipo_hogar !== interactive.tipoHogar) return false;
                    if (interactive.educacion && d.Educacion !== interactive.educacion) return false;

                    return true;
                });
            }, [rawData, selectedProvincias, selectedComunas, selectedGSE, selectedDeficit, interactive]);

            const data = useMemo(() => filteredAll.filter(d => d.Año === selectedYear), [filteredAll, selectedYear]);

            const stats = useMemo(() => {
                if (!selectedYear) return null;
                const total = data.reduce((a, c) => a + (c.Requerimientos || 0), 0);

                // Variación
                const sortedYears = [...options.years].reverse();
                const curIdx = sortedYears.indexOf(selectedYear);
                const prevYear = curIdx > 0 ? sortedYears[curIdx - 1] : null;
                const totalPrev = prevYear ? filteredAll.filter(d => d.Año === prevYear).reduce((a, c) => a + (c.Requerimientos || 0), 0) : 0;

                const aggregate = (key) => {
                    const m = {};
                    data.forEach(d => { m[d[key]] = (m[d[key]] || 0) + (d.Requerimientos || 0); });
                    return Object.entries(m).map(([name, value]) => ({ name, value }));
                };

                const comps = options.deficit.map(c => {
                    const v = data.filter(d => d.Componente_deficit === c).reduce((a, cr) => a + (cr.Requerimientos || 0), 0);
                    const vp = prevYear ? filteredAll.filter(d => d.Año === prevYear && d.Componente_deficit === c).reduce((a, cr) => a + (cr.Requerimientos || 0), 0) : null;
                    return { name: c, value: v, prev: vp };
                });

                return {
                    total, totalPrev,
                    components: comps,
                    hasPrev: !!prevYear,
                    prevYear,
                    deficit: aggregate('Componente_deficit'),
                    gse: aggregate('Grupo_socioeconomico'),
                    sexo: aggregate('Sexo'),
                    zona: aggregate('Zona'),
                    tipoHogar: aggregate('Tipo_hogar').sort((a, b) => b.value - a.value),
                    educacion: aggregate('Educacion'),
                    ranking: aggregate('Comuna').sort((a, b) => b.value - a.value)
                };
            }, [data, selectedYear, options, filteredAll]);

            const comparisonData = useMemo(() => {
                const map = {};
                filteredAll.forEach(d => {
                    if (!map[d.Comuna]) map[d.Comuna] = { name: d.Comuna, provincia: d.Provincia };
                    map[d.Comuna][d.Año] = (map[d.Comuna][d.Año] || 0) + d.Requerimientos;
                });
                return Object.values(map).sort((a, b) => a.name.localeCompare(b.name));
            }, [filteredAll]);

            if (loading) return (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 text-center">
                    <div className="w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-6"></div>
                    <h2 className="text-xl font-black text-slate-800 tracking-tight">Cargando Visualizador Maule</h2>
                    <p className="text-slate-400 font-bold text-xs uppercase tracking-widest mt-2">Sincronizando con Google Sheets...</p>
                </div>
            );

            if (error) return (
                <div className="min-h-screen flex items-center justify-center bg-rose-50 p-6 text-center">
                    <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl border border-rose-100 max-w-lg w-full">
                        <div className="w-20 h-20 bg-rose-100 text-rose-600 rounded-3xl flex items-center justify-center mx-auto mb-6 transform -rotate-6">
                            <Icon name="Activity" size={40} />
                        </div>
                        <h2 className="text-2xl font-black text-slate-800 mb-2">Fallo de Conexión</h2>
                        <p className="text-slate-500 text-sm mb-8 leading-relaxed">{error}</p>
                        <div className="bg-slate-50 p-6 rounded-2xl text-[10px] font-mono text-slate-400 text-left border border-slate-100 italic break-all">
                            Status: Connection Failed<br />ID: {CONFIG.spreadsheetId}
                        </div>
                        <button onClick={() => window.location.reload()} className="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 text-xs uppercase tracking-widest">Reintentar Sincronización</button>
                    </div>
                </div>
            );

            const toggleInteractive = (cat, val) => setInteractive(p => ({ ...p, [cat]: p[cat] === val ? null : val }));

            return (
                <div className="min-h-screen flex flex-col">
                    {/* NAV BAR */}
                    <nav className="bg-indigo-900 text-white px-6 md:px-12 py-5 sticky top-0 z-[100] border-b border-indigo-800/50 backdrop-blur-md bg-indigo-900/95 flex flex-col md:flex-row items-center justify-between gap-6">
                        <div className="flex items-center gap-6">
                            <div className="bg-white p-2.5 rounded-xl shadow-lg border border-white/20">
                                <img src="https://cchc.cl/documents/431409/0/logoCChC.png/002fea99-2039-beec-02a7-a92335532d6f?t=1695346405910" alt="Logo" className="h-8" />
                            </div>
                            <div>
                                <h1 className="text-xl font-black tracking-tighter leading-none">Unidad de Estudios</h1>
                                <p className="text-[10px] font-black text-indigo-300 uppercase tracking-[0.2em] mt-1.5">Región del Maule</p>
                            </div>
                        </div>

                        <div className="flex bg-white/5 p-1 rounded-2xl border border-white/10 backdrop-blur-sm">
                            <button onClick={() => setActiveTab('analisis')} className={`px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${activeTab === 'analisis' ? 'bg-white text-indigo-900 shadow-xl' : 'text-indigo-200 hover:text-white'}`}>Análisis Regional</button>
                            <button onClick={() => setActiveTab('comparacion')} className={`px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${activeTab === 'comparacion' ? 'bg-white text-indigo-900 shadow-xl' : 'text-indigo-200 hover:text-white'}`}>Comparativa Anual</button>
                        </div>

                        <div className="flex items-center gap-4">
                            <div className="relative">
                                <button onClick={() => setIsYearOpen(!isYearOpen)} className="flex items-center gap-3 bg-white/10 border border-white/10 hover:bg-white/20 px-4 py-2 rounded-xl transition-all">
                                    <span className="text-[10px] font-black text-indigo-300 uppercase">Año</span>
                                    <span className="text-sm font-black">{selectedYear}</span>
                                    <Icon name="ChevronDown" size={14} className="text-indigo-400" />
                                </button>
                                {isYearOpen && (
                                    <div className="absolute top-full right-0 mt-2 w-32 bg-white rounded-2xl shadow-2xl py-2 z-50 animate-in border border-slate-100">
                                        {options.years.map(y => (
                                            <div key={y} onClick={() => { setSelectedYear(y); setIsYearOpen(false); }} className={`px-4 py-2 text-xs font-bold cursor-pointer hover:bg-slate-50 ${selectedYear === y ? 'text-indigo-600 bg-indigo-50' : 'text-slate-600'}`}>{y}</div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <div className="w-10 h-10 bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 rounded-xl flex items-center justify-center animate-pulse"><Icon name="Wifi" size={20} /></div>
                        </div>
                    </nav>

                    <div className="flex-1 w-full max-w-[1600px] mx-auto p-6 md:p-10 grid grid-cols-1 lg:grid-cols-4 gap-10">
                        {/* SIDEBAR */}
                        <aside className="lg:col-span-1 space-y-8 h-fit lg:sticky lg:top-32">
                            <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-100 flex flex-col gap-6">
                                <div className="flex items-center justify-between">
                                    <h3 className="font-black text-slate-800 tracking-tight flex items-center gap-2"><Icon name="Sliders" size={18} /> Segmentación</h3>
                                    <button onClick={() => { setInteractive({ sexo: null, zona: null, gse: null, deficit: null, comuna: null, tipoHogar: null, educacion: null }); setSelectedProvincias(options.provincias); setSelectedComunas(options.comunas); }} className="text-[10px] font-black text-indigo-600 uppercase hover:underline">Limpiar</button>
                                </div>

                                <FilterDropdown label="Provincia" options={options.provincias} selected={selectedProvincias} onChange={p => {
                                    setSelectedProvincias(p);
                                    let c = []; p.forEach(pr => c.push(...MAULE_STRUCTURE.provincias[pr]));
                                    setSelectedComunas(c);
                                }} />
                                <FilterDropdown label="Comuna" options={options.comunas} selected={selectedComunas} onChange={setSelectedComunas} />
                                <FilterDropdown label="Grupo Socioeconómico" options={options.gse} selected={selectedGSE} onChange={setSelectedGSE} />
                                <FilterDropdown label="Componente Déficit" options={options.deficit} selected={selectedDeficit} onChange={setSelectedDeficit} />

                                <div className="pt-6 border-t border-slate-50 flex flex-col gap-3">
                                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Resumen Filtros</p>
                                    <div className="p-4 bg-slate-50 rounded-2xl text-xs font-bold text-slate-600 border border-slate-100 flex items-center gap-3">
                                        <Icon name="Map" size={18} className="text-slate-400" />
                                        {selectedComunas.length} de 30 comunas
                                    </div>
                                </div>
                            </div>
                        </aside>

                        {/* CONTENT */}
                        <main className="lg:col-span-3 space-y-10">
                            {activeTab === 'analisis' ? (
                                <div className="space-y-10 animate-in">
                                    {/* KPIS */}
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <KPICard title="Déficit Habitacional Total" value={stats.total} prevValue={stats.totalPrev} isTotal />
                                        <div className="md:col-span-2 bg-gradient-to-br from-indigo-600 via-indigo-700 to-indigo-800 rounded-[2.5rem] p-10 text-white relative overflow-hidden shadow-2xl shadow-indigo-100">
                                            <div className="relative z-10 flex flex-col justify-center h-full">
                                                <span className="text-[10px] font-black uppercase tracking-[0.3em] text-indigo-300">Panorama Regional</span>
                                                <h3 className="text-4xl font-black tracking-tighter mt-2">Balance de Vivienda - Maule</h3>
                                                <p className="text-indigo-100 text-sm mt-4 max-w-md leading-relaxed">Visualización técnica de los requerimientos de vivienda, segmentados por variables sociodemográficas y geográficas regionales.</p>
                                                <div className="mt-8 flex gap-4">
                                                    <div className="px-5 py-2.5 bg-white/10 backdrop-blur-xl rounded-2xl text-[10px] font-black uppercase tracking-widest border border-white/5 shadow-xl">Data Oficial</div>
                                                    <div className="px-5 py-2.5 bg-white/10 backdrop-blur-xl rounded-2xl text-[10px] font-black uppercase tracking-widest border border-white/5 shadow-xl">Update CASEN</div>
                                                </div>
                                            </div>
                                            <div className="absolute -right-20 -bottom-20 opacity-10 blur-2xl animate-pulse">
                                                <Icon name="Home" size={400} />
                                            </div>
                                        </div>
                                    </div>

                                    {/* VARIACION POR COMPONENTES */}
                                    <div className="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden">
                                        <div onClick={() => setIsKPIsOpen(!isKPIsOpen)} className="p-6 border-b border-slate-50 flex items-center justify-between cursor-pointer hover:bg-slate-50/50 transition-colors">
                                            <h3 className="font-black text-slate-800 tracking-tight flex items-center gap-3"><Icon name="TrendingUp" size={18} className="text-indigo-600" /> Variación por Componentes {stats.hasPrev ? `vs ${stats.prevYear}` : ''}</h3>
                                            <Icon name={isKPIsOpen ? 'Minimize2' : 'Maximize2'} size={18} className="text-slate-400" />
                                        </div>
                                        {isKPIsOpen && (
                                            <div className="p-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 bg-slate-50/30">
                                                {stats.components.map(c => (
                                                    <KPICard key={c.name} title={c.name} value={c.value} prevValue={c.prev} />
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    {/* ROW 1: BAR + PIE */}
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                        <ChartCard title="Componentes del Déficit" icon="AlertCircle" iconColor="text-amber-500">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <BarChart data={stats.deficit}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                    <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{ fontSize: 10, fontWeight: 700, fill: '#64748b' }} interval={0} />
                                                    <YAxis axisLine={false} tickLine={false} tick={{ fontSize: 10, fill: '#94a3b8' }} />
                                                    <RechartsTooltip cursor={{ fill: '#f8fafc' }} contentStyle={{ borderRadius: '24px', border: 'none', boxShadow: '0 25px 50px -12px rgb(0 0 0 / 0.1)' }} />
                                                    <Bar dataKey="value" fill="#f59e0b" radius={[12, 12, 2, 2]} barSize={50} onClick={e => toggleInteractive('deficit', e.name)} cursor="pointer" />
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </ChartCard>

                                        <ChartCard title="Distribución por GSE" icon="Users" iconColor="text-emerald-500">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <PieChart>
                                                    <Pie data={stats.gse} innerRadius={80} outerRadius={120} paddingAngle={8} dataKey="value" stroke="none" onClick={e => toggleInteractive('gse', e.name)} cursor="pointer">
                                                        {stats.gse.map((e, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} cornerRadius={8} />)}
                                                    </Pie>
                                                    <RechartsTooltip contentStyle={{ borderRadius: '24px', border: 'none' }} />
                                                    <Legend verticalAlign="bottom" align="center" iconType="circle" />
                                                </PieChart>
                                            </ResponsiveContainer>
                                        </ChartCard>
                                    </div>

                                    {/* ROW 2: BAR + PIE */}
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                        <ChartCard title="Sexo del Jefe de Hogar" icon="User" iconColor="text-indigo-500">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <BarChart data={stats.sexo}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                    <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{ fontSize: 11, fontWeight: 700 }} />
                                                    <YAxis axisLine={false} tickLine={false} tick={{ fontSize: 11 }} />
                                                    <RechartsTooltip />
                                                    <Bar dataKey="value" radius={[10, 10, 2, 2]} barSize={60} onClick={e => toggleInteractive('sexo', e.name)} cursor="pointer">
                                                        {stats.sexo.map((e, i) => <Cell key={i} fill={SEXO_COLORS[i % SEXO_COLORS.length]} />)}
                                                    </Bar>
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </ChartCard>

                                        <ChartCard title="Contexto Territorial (Zona)" icon="TreePine" iconColor="text-sky-500">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <PieChart>
                                                    <Pie data={stats.zona} cx="50%" cy="50%" outerRadius={110} dataKey="value" stroke="none" onClick={e => toggleInteractive('zona', e.name)} cursor="pointer">
                                                        {stats.zona.map((e, i) => <Cell key={i} fill={ZONA_COLORS[i % ZONA_COLORS.length]} cornerRadius={10} />)}
                                                    </Pie>
                                                    <RechartsTooltip />
                                                    <Legend />
                                                </PieChart>
                                            </ResponsiveContainer>
                                        </ChartCard>
                                    </div>

                                    {/* ROW 3: HORIZONTAL BAR + ANILLO */}
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                        <ChartCard title="Tipología de Hogar" icon="LayoutList" iconColor="text-purple-500">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <BarChart data={stats.tipoHogar} layout="vertical">
                                                    <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#f1f5f9" />
                                                    <XAxis type="number" hide />
                                                    <YAxis dataKey="name" type="category" width={140} tick={{ fontSize: 10, fontWeight: 700 }} axisLine={false} tickLine={false} />
                                                    <RechartsTooltip />
                                                    <Bar dataKey="value" fill="#8b5cf6" radius={[0, 8, 8, 0]} barSize={25} onClick={e => toggleInteractive('tipoHogar', e.name)} cursor="pointer" />
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </ChartCard>

                                        <ChartCard title="Nivel Educacional" icon="GraduationCap" iconColor="text-teal-500">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <PieChart>
                                                    <Pie data={stats.educacion} innerRadius={70} outerRadius={110} paddingAngle={2} dataKey="value" stroke="none" onClick={e => toggleInteractive('educacion', e.name)} cursor="pointer">
                                                        {stats.educacion.map((e, i) => <Cell key={i} fill={COLORS[(i + 3) % COLORS.length]} cornerRadius={10} />)}
                                                    </Pie>
                                                    <RechartsTooltip />
                                                    <Legend verticalAlign="bottom" height={36} />
                                                </PieChart>
                                            </ResponsiveContainer>
                                        </ChartCard>
                                    </div>

                                    {/* RANKING COMUNAL */}
                                    <ChartCard title="Distribución Geográfica (Ranking)" icon="Map" iconColor="text-indigo-600" height="h-[600px]">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart data={stats.ranking} layout="vertical" margin={{ right: 40 }}>
                                                <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#f1f5f9" />
                                                <XAxis type="number" hide />
                                                <YAxis dataKey="name" type="category" width={120} tick={{ fontSize: 10, fontWeight: 700 }} axisLine={false} tickLine={false} />
                                                <RechartsTooltip />
                                                <Bar dataKey="value" fill="#3b82f6" radius={[0, 10, 10, 0]} barSize={30} onClick={e => toggleInteractive('comuna', e.name)} cursor="pointer" />
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </ChartCard>
                                </div>
                            ) : (
                                <div className="space-y-10 animate-in">
                                    <div className="bg-white rounded-[3rem] border border-slate-100 shadow-xl overflow-hidden">
                                        <div className="p-10 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                                            <div>
                                                <h3 className="text-3xl font-black text-slate-800 tracking-tighter">Matriz Comparativa Regional</h3>
                                                <p className="text-slate-400 text-sm mt-1 uppercase font-bold tracking-widest">Evolución histórica de requerimientos habitacionales</p>
                                            </div>
                                            <div className="flex gap-4">
                                                {options.years.map((y, i) => (
                                                    <span key={y} className="flex items-center gap-2 text-[10px] font-black uppercase tracking-widest px-3 py-1.5 rounded-full bg-white border border-slate-100 shadow-sm">
                                                        <div className="w-2 h-2 rounded-full" style={{ backgroundColor: COLORS[i % COLORS.length] }}></div>
                                                        {y}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="overflow-x-auto custom-scrollbar">
                                            <table className="w-full text-left">
                                                <thead>
                                                    <tr className="bg-slate-100/50">
                                                        <th className="px-10 py-6 text-[10px] font-black text-slate-400 uppercase tracking-widest">Provincia / Comuna</th>
                                                        {options.years.map(y => <th key={y} className="px-6 py-6 text-right text-[10px] font-black text-slate-400 uppercase tracking-widest">{y}</th>)}
                                                        <th className="px-10 py-6 text-right text-[10px] font-black text-slate-400 uppercase tracking-widest">Variación Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-50">
                                                    {comparisonData.map(row => {
                                                        const vals = options.years.map(y => row[y] || 0);
                                                        const diff = (vals[0] || 0) - (vals[vals.length - 1] || 0);
                                                        const isGrowth = diff > 0;
                                                        return (
                                                            <tr key={row.name} className="hover:bg-slate-50/50 transition-colors group">
                                                                <td className="px-10 py-5">
                                                                    <div className="text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-1">{row.provincia}</div>
                                                                    <div className="text-sm font-black text-slate-700 uppercase group-hover:text-indigo-600 transition-colors">{row.name}</div>
                                                                </td>
                                                                {options.years.map(y => (
                                                                    <td key={y} className="px-6 py-5 text-right font-black text-sm text-slate-800">
                                                                        {row[y] ? row[y].toLocaleString('es-CL') : '-'}
                                                                    </td>
                                                                ))}
                                                                <td className={`px-10 py-5 text-right font-black text-sm ${isGrowth ? 'text-rose-500' : 'text-emerald-500'}`}>
                                                                    {diff !== 0 && (diff > 0 ? '+' : '')}{diff.toLocaleString('es-CL')}
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>

                    <footer className="mt-20 py-20 bg-slate-900 text-slate-400 text-center px-10 border-t border-white/5">
                        <div className="flex flex-col items-center gap-10">
                            <div className="bg-white p-3 rounded-2xl shadow-xl grayscale opacity-50">
                                <img src="https://cchc.cl/documents/431409/0/logoCChC.png/002fea99-2039-beec-02a7-a92335532d6f?t=1695346405910" alt="Logo" className="h-10" />
                            </div>
                            <div className="space-y-4">
                                <p className="text-[10px] font-black uppercase tracking-[0.5em]">Cámara Chilena de la Construcción - Sede Maule</p>
                                <p className="text-[9px] opacity-40 max-w-lg leading-relaxed mx-auto font-medium">Plataforma de visualización de datos de vivienda región del Maule. Basado en registros administrativos oficiales y encuestas regionales. Prohibida su reproducción total o parcial sin autorización.</p>
                            </div>
                            <div className="flex gap-8 opacity-20">
                                <Icon name="Activity" size={24} />
                                <Icon name="Database" size={24} />
                                <Icon name="ShieldCheck" size={24} />
                                <Icon name="Cpu" size={24} />
                            </div>
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>